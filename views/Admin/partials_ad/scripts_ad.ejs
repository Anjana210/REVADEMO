<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Theme Toggle Logic ---
        const themeButton = document.getElementById('theme-toggle');
        // This 'if' block is the fix. It prevents errors if the button doesn't exist.
        if (themeButton) {
            const themeIcon = themeButton.querySelector('i');
            const htmlEl = document.documentElement;

            function applyTheme(theme) {
                localStorage.setItem('theme', theme);
                if (theme === 'dark') {
                    htmlEl.classList.add('dark');
                    themeIcon.className = 'fas fa-sun';
                } else {
                    htmlEl.classList.remove('dark');
                    themeIcon.className = 'fas fa-moon';
                }
            }

            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            themeButton.addEventListener('click', () => {
                const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(newTheme);
            });
        }

        // --- User Dropdown Logic ---
        const dropdown = document.getElementById('user-dropdown');
        if (dropdown) {
            const toggle = document.getElementById('dropdown-toggle');
            const menu = document.getElementById('dropdown-menu');
            
            toggle.addEventListener('click', (event) => {
                event.stopPropagation();
                menu.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });
        }

        // --- Geolocation logging for staff (master/operator) ---
        try {
            const isStaff = <%- JSON.stringify(!!(user && (user.role === 'admin' || user.role === 'operator'))) %>;
            const hasCompany = <%- JSON.stringify(!!(user && user.companyId)) %>;
            if (isStaff && hasCompany && 'geolocation' in navigator) {
                const LS_KEY = 'reva_last_geo_sent_at';
                const SS_KEY = 'reva_geo_sent_session';
                const now = Date.now();
                const last = Number(localStorage.getItem(LS_KEY) || '0');
                const sentThisSession = sessionStorage.getItem(SS_KEY) === '1';
                const shouldSend = !sentThisSession || !last || (now - last) > (10 * 60 * 1000);
                if (shouldSend) {
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        try {
                            console.log('[Geo] success coords', { lat, lng });
                            await fetch('/api/v1/activity/location', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ lat, lng, action: 'LOGIN' })
                            }).then(r => { console.log('[Geo] server response (success)', r.status); return r; });
                            localStorage.setItem(LS_KEY, String(Date.now()));
                            sessionStorage.setItem(SS_KEY, '1');
                        } catch (e) { /* ignore */ }
                    }, async (error) => {
                        console.warn('[Geo] error callback', error && (error.code + ':' + error.message));
                        try {
                            await fetch('/api/v1/activity/location', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ lat: null, lng: null, action: 'LOCATION_DENIED' })
                            }).then(r => { console.log('[Geo] server response (denied)', r.status); return r; });
                            sessionStorage.setItem(SS_KEY, '1');
                        } catch (e) { /* ignore */ }
                    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
                }
            }
        } catch (_) { /* ignore geolocation errors */ }
    });
</script>